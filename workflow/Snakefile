import pandas as pd
configfile: "config/config.yaml"

RESULTS = pd.read_csv(config["result_params"]).set_index('name')
# SCENARIOS = pd.read_csv(config["scenarios"]).set_index('name')
MODELRUNS = range(config['replicates'])

include: "rules/osemosys.smk"

rule all:
    input: "results/InterconnectorActivity.csv"
    message: "Running pipeline to generate the files '{input}'"

rule create_sample:
    params: replicates=config['replicates']
    output: expand('modelruns/{x}_sample.txt', x=range(config['replicates']))
    shell:
        "python workflow/scripts/create_sample.py {params.replicates}"

rule extract_results_interconnector_activity:
    input: expand("results/{modelrun}/ProductionByTechnologyAnnual.csv", modelrun=MODELRUNS)
    output: "results/InterconnectorActivity.csv"
    script: "scripts/interconnectoractivity.py"

rule clean:
    shell:
        "rm -rf results/* && rm -rf results/* && rm -rf modelruns/*"

rule clean_plots:
    shell:
        "rm -f results/{modelrun}/*.pdf"

rule plot:
    input: "results/{modelrun}/{result}.csv"
    output: "results/{modelrun}/{result}.pdf"
    conda: "envs/plot.yaml"
    message: "Generating plot using '{input}' and writing to '{output}'"
    shell:
        "python workflow/scripts/plot_results.py {input} {output}"

rule make_dag:
    output: pipe("dag.txt")
    shell:
        "snakemake --dag > {output}"

rule plot_dag:
    input: "dag.txt"
    output: "dag.png"
    conda: "envs/dag.yaml"
    shell:
        "dot -Tpng {input} > dag.png && open dag.png"
